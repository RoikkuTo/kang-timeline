"use strict";!function(t,e){var i;"function"==typeof define&&define.amd?define(["exports","./Task.js","./Keytime.js","./Chain.js","./Util.js"],e):"undefined"!=typeof exports?e(exports,require("./Task.js"),require("./Keytime.js"),require("./Chain.js"),require("./Util.js")):(e(i={},t.Task,t.Keytime,t.Chain,t.Util),t.undefined=i)}(void 0,function(t,e,i,n,s){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var a=l(e),r=l(i),u=l(n),o=l(s);function l(t){return t&&t.__esModule?t:{default:t}}function h(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function c(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function f(t,e,i){return e&&c(t.prototype,e),i&&c(t,i),t}var d=[],k=(f(y,null,[{key:"loop",value:function(e){d.forEach(function(t){return t(e)}),y.requestId=requestAnimationFrame(y.loop)}},{key:"start",value:function(){y.requestId=requestAnimationFrame(y.loop)}},{key:"subscribe",value:function(t){d.push(t)}}]),y);function y(){h(this,y)}k.start(),console.log(k);var v=(f(b,[{key:"consume",value:function(t){this.controller(t),this.util.compare(t),this.keytime.compare(t)}},{key:"controller",value:function(t){switch(this.initial||(this.initial=t),this.state){case"start":this.bank&&(this.initial+=this.bank,this.bank=null),this.current=(t-this.initial)*this.ratio,this.task&&this.task.run(new Timestamp({currentTime:this.current,globalTime:t}));break;case"stop":this.bank=(t-this.initial-this.current)*this.ratio;break;case"reset":this.state="stop",this.initial=0,this.current=0;break;default:console.error("Undefined state.")}}},{key:"request",value:function(e,t){var i=this,n=1<arguments.length&&void 0!==t?t:0;return this.chain.add(function(t){i.util.key={delay:n,callback:function(){i.state=e,t()}}}.bind(this))}},{key:"start",value:function(t){return this.request("start",t)}},{key:"stop",value:function(t){return this.request("stop",t)}},{key:"reset",value:function(t){return this.request("reset",t)}},{key:"addKeytime",value:function(t){this.keytime.add(t)}}]),b);function b(t){var e=t.id,i=t.ratio,n=t.task;h(this,b),this.id=e||Date.now(),this.ratio=i||1,this.task=n?new a.default(n):null,this.keytime=new r.default,this.chain=new u.default(this),this.util=new o.default(this),this.bank=0,this.initial=0,this.current=0,this.state="stop",k.subscribe(this.consume.bind(this))}t.default=v});