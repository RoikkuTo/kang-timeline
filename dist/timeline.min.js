var __defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(t,s,e)=>s in t?__defProp(t,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):t[s]=e,__spreadValues=(t,s)=>{for(var e in s||(s={}))__hasOwnProp.call(s,e)&&__defNormalProp(t,e,s[e]);if(__getOwnPropSymbols)for(var e of __getOwnPropSymbols(s))__propIsEnum.call(s,e)&&__defNormalProp(t,e,s[e]);return t},__spreadProps=(t,s)=>__defProps(t,__getOwnPropDescs(s));!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):(t="undefined"!=typeof globalThis?globalThis:t||self).Timeline=s()}(this,(function(){"use strict";let t=[];class s{static loop(e){for(const s of t)s.consume(e);s.requestId=requestAnimationFrame(s.loop)}static start(){s.requestId=requestAnimationFrame(s.loop)}static stop(){cancelAnimationFrame(s.requestId)}static subscribe(s){t.push(s)}static checkId(s){return t.every((t=>t.id!==s))}static unsubscribe(s){const e=t.findIndex((t=>t.id===s));-1!==e&&t.splice(e,1)}}s.start();class e{constructor(t){if(this.frequency=1,this.task=()=>null,this.count=0,"object"==typeof t){const{frequency:s,run:e}=t;this.frequency=s||1,this.task=e}else"function"==typeof t&&(this.task=t)}run(t){this.task&&t.currentTime%this.frequency>0&&(this.count++,this.task(__spreadProps(__spreadValues({},t),{count:this.count})))}}class i{constructor(){this.list=[],this.index=0}add(t){this.list.push(__spreadValues({id:Math.random()+Date.now()},t)),this.list.sort(((t,s)=>t.timestamp<s.timestamp?-1:t.timestamp>s.timestamp?1:0))}remove(t){const s=this.list.map((t=>t.id)).indexOf(t);this.list.splice(s,1),this.index--}compare(t){this.list[this.index]&&this.list[this.index].timestamp<=t.currentTime&&(this.list[this.index].task(t),this.index++)}}class r{constructor(t){this.link=null,this.context=t}add(t,s=(()=>null)){const e=this.link;return this.link=new Promise((async function(i,r){await e,await new Promise(t).then((()=>{s(),i(null)})).catch((()=>{console.error("Missing resolve in the request function."),s(),r()}))})),this.context}}class n{constructor(t){this.temp=null,this.keytime=null,this.timestamp=0,this.context=t}compare(t){this.keytime&&(null===this.temp&&(this.temp=t.globalTime+this.keytime.delay),null!==this.temp&&this.temp<=t.globalTime&&(this.keytime.callback(t),this.keytime=null,this.temp=null))}}class a{constructor(t,s){this.currentTime=t,this.globalTime=s}}return class{constructor({id:t,speed:e,task:a,loop:h,range:o}={}){var l;this._id=Date.now(),this._range=null,this._state="stop",this.taskObj=null,this.bank=null,this.initial=0,this.current=0,this._min=0,this._max=null,this.finishHandlers=[],this.isFinished=!1,this.sync={start:t=>{this._state="start",null==t||t()},stop:t=>{this._state="stop",null==t||t()},reset:t=>{this._state="reset",null==t||t()}},t&&(this.id=t),this.speed=e||1,a&&(this.task=a),o&&(this.range=o),this.loop=!!h,this.userKeytimes=new i,this.chain=new r(this),this.utilKeytimes=new n(this),Array.isArray(this._range)&&(this.current=null==(l=this._range)?void 0:l[0]),s.subscribe(this)}get id(){return this._id}set id(t){s.checkId(t)?this._id=t:console.error(`ERROR: The "${t}" id has already been defined. (Timeline Library)`)}get task(){return this._task}set task(t){this._task=t,this.taskObj=t?new e(t):null}get range(){return this._range}set range(t){var s,e;this._range=t,this._min=Array.isArray(this._range)?null==(s=this._range)?void 0:s[0]:0,this._max=Array.isArray(this._range)?null==(e=this._range)?void 0:e[1]:this._range}get min(){return this._min}get max(){return this._max}get state(){return this._state}get currentTimestamp(){return this.current}consume(t){this.controller(t);const s=new a(this.current,t);this.utilKeytimes.compare(s),this.userKeytimes.compare(s)}controller(t){var s;switch(this.initial||(this.initial=t-(Array.isArray(this._range)?this._range[0]:0)),this._state){case"start":if(this.bank&&(this.initial+=this.bank,this.bank=null),this.isFinished&&(this.isFinished=!1),this.current=(t-this.initial)*this.speed,this.taskObj&&this.taskObj.run(new a(this.current,t)),this._range&&(Array.isArray(this._range)&&(null==(s=this._range)?void 0:s[1])<=this.current||this._range<=this.current)){const t=()=>{for(const t of this.finishHandlers)t()};this.loop?(this.sync.reset(),this.start()):(this.isFinished=!0,this.sync.stop(t))}break;case"stop":this.bank=(t-this.initial-this.current)*this.speed;break;case"reset":this._state="stop",this.current=Array.isArray(this._range)?this._range[0]:0,this.initial=0,this.bank=null,this.taskObj&&(this.taskObj.count=0);break;default:console.error("Undefined state.")}}request(t,s=0,e){return this.chain.add(((e,i)=>{this.utilKeytimes.keytime={id:Date.now(),delay:s,callback:()=>{this._state=t,e(null)}}}).bind(this),e)}start(t,s){return this.request("start",t,s)}stop(t,s){return this.request("stop",t,s)}reset(t,s){return this.request("reset",t,s)}delete(){s.unsubscribe(this._id)}setTimestamp(t){this.current-=this.current-t}addKeytime(t){this.userKeytimes.add(t)}removeKeytime(t){this.userKeytimes.remove(t)}listKeytimes(){return this.userKeytimes.list}onFinish(t){this.finishHandlers.push(t)}offFinish(t){const s=this.finishHandlers.indexOf(t);-1!==s&&this.finishHandlers.splice(s,1)}}}));
