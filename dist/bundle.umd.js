!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).umd=e()}(this,(function(){"use strict";var t=[];class e{static loop(i){for(var s of t)s(i);e.requestId=requestAnimationFrame(e.loop)}static start(){e.requestId=requestAnimationFrame(e.loop)}static subscribe(e){t.push(e)}static checkId(e){return t.every(t=>t.id!==e)}static unsubscrabe(t){}}function i(t,e,i,s,r,n,o){try{var c=t[n](o),a=c.value}catch(t){return void i(t)}c.done?e(a):Promise.resolve(a).then(s,r)}function s(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function r(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,s)}return i}function n(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?r(Object(i),!0).forEach((function(e){s(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}e.start();class o{constructor(t){if("object"==typeof t){var{frequency:e,run:i}=t;this.frequency=e||0,this.task=i}else"function"==typeof t&&(this.frequency=0,this.task=t);this.count=0}run(t){t.currentTime>=this.frequency*this.count&&(this.count++,this.task(n(n({},t),{},{count:this.count})))}}class c{constructor(){this.list=[],this.index=0}add(t){this.list.push(t),this.list.sort((t,e)=>t.timestamp<e.timestamp?-1:t.timestamp>e.timestamp?1:0)}remove(t){var e=this.list.map(t=>t.id).indexOf(t);this.list.splice(e,0),this.index--}compare(t){this.list[this.index]&&this.list[this.index].currentTime<=t.currentTime&&(this.list[this.index].run(t),this.index++)}}class a{constructor(t){this.context=t,this.link=null}add(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>null,s=this.link;return this.link=new Promise(function(){var r,n=(r=function*(i,r){yield s,yield new Promise((e,i)=>t(e,i)).then(t=>{e(t),i()}).catch(t=>{console.error("Missing resolve in the request function."),e(t),r()})},function(){var t=this,e=arguments;return new Promise((function(s,n){var o=r.apply(t,e);function c(t){i(o,s,n,c,a,"next",t)}function a(t){i(o,s,n,c,a,"throw",t)}c(void 0)}))});return function(t,e){return n.apply(this,arguments)}}()),this.context}}class h{constructor(t){this.context=t,this.temp=null,this.key=null,this.initial=0,this.timestamp=0}compare(t){this.key&&(null===this.temp&&(this.temp=t.currentTime+this.key.delay),null!==this.temp&&this.temp<=t.currentTime&&(this.key.callback(t),this.key=null,this.temp=null))}}class u{constructor(t){var{currentTime:e,globalTime:i}=t;this.currentTime=e,this.globalTime=i}}return class{constructor(t){var{id:i,ratio:s,task:r}=t;this.id=(t=>{t&&(e.checkId(t)?this.id=t:console.error('ERROR: The "'.concat(t,'" id has already been defined. (Timeline Library)')))})(i),this.ratio=s||1,this.task=r?new o(r):null,this.keytime=new c,this.chain=new a(this),this.util=new h(this),this.bank=0,this.initial=0,this.current=0,this.state="stop",e.subscribe(this.consume.bind(this))}consume(t){this.controller(t);var e=new u({currentTime:this.current,globalTime:t});this.util.compare(e),this.keytime.compare(e)}id(t){t?e.checkId(t)?this.id=t:console.error('ERROR: The "'.concat(t,'" id has already been defined. (Timeline Library)')):console.error("ERROR: Please specify an id. (Timeline Library)")}ratio(t){this.ratio=t}task(t){this.task=new o(t)}addKeytime(t){this.keytime.add(t)}removeKeytime(t){this.keytime.remove(t)}listKeytimes(){return this.keytime.list}controller(t){switch(this.initial||(this.initial=t),this.state){case"start":this.bank&&(this.initial+=this.bank,this.bank=null),this.current=(t-this.initial)*this.ratio,this.task&&this.task.run(new u({currentTime:this.current,globalTime:t}));break;case"stop":this.bank=(t-this.initial-this.current)*this.ratio;break;case"reset":this.state="stop",this.initial=0,this.current=0;break;default:console.error("Undefined state.")}}request(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.chain.add(((i,s)=>{this.util.key={delay:e,callback:e=>{this.state=t,i()}}}).bind(this))}start(t){return this.request("start",t)}stop(t){return this.request("stop",t)}reset(t){return this.request("reset",t)}}}));
